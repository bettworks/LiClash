# 自启动功能融合总结

## 实现方案

### 核心思路
将**管理员自启动**和**普通自启动**融合为一个智能开关，自动选择最佳模式。

### 工作流程

#### Windows平台
1. **启用自启动时**：
   - 优先尝试管理员模式（任务计划程序）
     - 检查是否有管理员权限
     - 无权限时自动请求提升（UAC）
     - 注册任务计划
   - 如果管理员模式失败，自动回退到普通模式（注册表）
   - 确保两种模式不会同时启用（避免冲突）

2. **禁用自启动时**：
   - 同时禁用两种模式
   - 删除任务计划（如果存在）
   - 删除注册表项（如果存在）

3. **状态检测**：
   - 优先检查任务计划（管理员模式）
   - 其次检查注册表（普通模式）
   - 返回当前实际使用的模式

#### 其他平台（macOS/Linux）
- 只使用普通模式（launch_at_startup插件）
- 不涉及管理员模式

## 代码修改

### 1. `lib/common/launch.dart` - 核心逻辑

**新增功能：**
- `AutoLaunchMode` 枚举：`none`、`normal`、`admin`
- `getCurrentMode()`: 检测当前使用的模式
- `enable({preferAdmin})`: 智能启用（优先管理员模式）
- `disable()`: 同时禁用两种模式
- `getModeDescription()`: 获取模式描述文本

**关键逻辑：**
```dart
// 智能启用：优先管理员模式，失败回退普通模式
if (system.isWindows && preferAdmin) {
  // 尝试管理员模式
  if (成功) {
    禁用普通模式;
    return true;
  }
}
// 回退到普通模式
启用普通模式;
删除任务计划（如果存在）;
```

### 2. `lib/views/application_setting.dart` - UI组件

**改进：**
- `AutoLaunchItem` 改为 `ConsumerStatefulWidget`
- 实时显示当前模式（普通模式/管理员模式）
- 添加更新状态指示（防止重复操作）
- 移除 `AdminAutoLaunchItem` 组件

**UI显示：**
- 标题：自启动
- 副标题：跟随系统自启动（普通模式）/ 跟随系统自启动（管理员模式）

### 3. `lib/controller.dart` - 状态同步

**改进：**
- 启动时同步自启动状态
- 确保配置与实际状态一致
- 如果已启用，智能更新到最佳模式

## 用户体验

### 优势

1. **简化操作**
   - ✅ 只需一个开关
   - ✅ 自动选择最佳模式
   - ✅ 无需手动选择

2. **智能回退**
   - ✅ 管理员模式失败自动使用普通模式
   - ✅ 用户无需关心技术细节

3. **状态透明**
   - ✅ 显示当前使用的模式
   - ✅ 用户知道实际运行方式

4. **避免冲突**
   - ✅ 确保两种模式不会同时启用
   - ✅ 切换时自动清理旧模式

### 使用场景

**场景1：普通用户**
- 启用自启动 → 自动使用普通模式（注册表）
- 显示：跟随系统自启动（普通模式）

**场景2：管理员用户**
- 启用自启动 → 自动使用管理员模式（任务计划）
- 显示：跟随系统自启动（管理员模式）

**场景3：权限提升**
- 启用自启动 → 请求UAC → 成功则使用管理员模式
- 用户取消UAC → 自动回退到普通模式

## 向后兼容

### 配置迁移

**旧配置：**
```dart
{
  "autoLaunch": true,
  "adminAutoLaunch": false  // 旧字段，已废弃
}
```

**新配置：**
```dart
{
  "autoLaunch": true  // 统一字段，自动选择模式
}
```

**处理方式：**
- `adminAutoLaunch` 字段保留（向后兼容）
- 但不再使用，由 `autoLaunch` 统一管理
- 启动时自动迁移到新逻辑

## 测试要点

### 1. 基本功能测试
- ✅ 启用自启动（普通用户）
- ✅ 启用自启动（管理员用户）
- ✅ 禁用自启动
- ✅ 状态显示正确

### 2. 权限测试
- ✅ UAC提示正常
- ✅ 用户取消UAC后回退普通模式
- ✅ 权限获取失败后回退普通模式

### 3. 冲突测试
- ✅ 两种模式不会同时启用
- ✅ 切换模式时自动清理旧模式
- ✅ 禁用时同时清理两种模式

### 4. 状态同步测试
- ✅ 启动时正确检测当前模式
- ✅ 配置与实际状态一致
- ✅ 模式描述实时更新

## 注意事项

1. **权限请求**
   - 首次启用时可能需要UAC提示
   - 用户取消后自动使用普通模式
   - 不会强制要求管理员权限

2. **状态检测**
   - 启动时检测实际状态
   - 如果配置与实际不一致，同步到实际状态
   - 避免配置漂移

3. **错误处理**
   - 所有操作都有错误处理
   - 失败时恢复开关状态
   - 记录错误日志

4. **性能优化**
   - 模式检测有缓存
   - 避免频繁查询系统状态
   - 异步操作不阻塞UI

## 后续优化建议

1. **模式切换**
   - 可以添加手动切换模式的功能（高级设置）
   - 允许用户强制使用某种模式

2. **状态通知**
   - 模式切换时显示通知
   - 提示用户当前使用的模式

3. **迁移提示**
   - 检测到旧配置时提示用户
   - 说明新功能的使用方式

